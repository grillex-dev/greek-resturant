generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

//////////////////////////////////////////////////////
// ENUMS
//////////////////////////////////////////////////////

enum UserRole {
  ADMIN
  CUSTOMER
}

enum OrderStatus {
  PENDING
  PAID
  FAILED
  CANCELLED
}

enum CustomizationType {
  EXTRA
  REMOVED_COMPONENT
}

enum FulfillmentType {
  DELIVERY
  PICKUP
  DINE_IN
}

//////////////////////////////////////////////////////
// USERS
//////////////////////////////////////////////////////

model User {
  id        String   @id @default(uuid())
  name      String?
  email     String?  @unique
  password  String?     
  role      UserRole @default(CUSTOMER)
  createdAt DateTime @default(now())

  orders    Order[]
  cartItems CartItem[]
}

//////////////////////////////////////////////////////
// RESTAURANT
//////////////////////////////////////////////////////

model Restaurant {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())

  categories Category[]
  products   Product[]
  extras     Extra[]
  components Component[]
  tables     Table[]
  orders     Order[]
}

//////////////////////////////////////////////////////
// TABLES (FOR DINE-IN)
//////////////////////////////////////////////////////

model Table {
  id           String @id @default(uuid())
  tableNumber  String
  capacity     Int?

  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])
  restaurantId String
  
  fulfillmentDetails FulfillmentDetails[]
}

//////////////////////////////////////////////////////
// CATEGORIES
//////////////////////////////////////////////////////

model Category {
  id           String @id @default(uuid())
  name         String

  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])
  restaurantId String

  products     Product[]
}

//////////////////////////////////////////////////////
// PRODUCTS
//////////////////////////////////////////////////////

model Product {
  id           String   @id @default(uuid())
  name         String
  description  String?
  basePrice    Decimal  @db.Decimal(10,2)
  imageUrl     String?
  isActive     Boolean  @default(true)

  category     Category @relation(fields: [categoryId], references: [id])
  categoryId   String

  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])
  restaurantId String

  components   ProductComponent[]
  extras       ProductExtra[]

  cartItems    CartItem[]
  orderItems   OrderItem[]

  createdAt    DateTime @default(now())
}

//////////////////////////////////////////////////////
// COMPONENTS
//////////////////////////////////////////////////////

model Component {
  id           String  @id @default(uuid())
  name         String
  costImpact   Decimal @db.Decimal(10,2)

  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])
  restaurantId String

  products     ProductComponent[]
}

model ProductComponent {
  id           String   @id @default(uuid())
  product      Product  @relation(fields: [productId], references: [id])
  productId    String

  component    Component @relation(fields: [componentId], references: [id])
  componentId  String

  isRemovable  Boolean @default(true)

  @@unique([productId, componentId])
}

//////////////////////////////////////////////////////
// EXTRAS
//////////////////////////////////////////////////////

model Extra {
  id           String  @id @default(uuid())
  name         String
  price        Decimal @db.Decimal(10,2)

  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])
  restaurantId String

  products     ProductExtra[]
}

model ProductExtra {
  id        String  @id @default(uuid())
  product   Product @relation(fields: [productId], references: [id])
  productId String

  extra     Extra   @relation(fields: [extraId], references: [id])
  extraId   String

  @@unique([productId, extraId])
}

//////////////////////////////////////////////////////
// CART
//////////////////////////////////////////////////////

model CartItem {
  id           String  @id @default(uuid())
  user         User?   @relation(fields: [userId], references: [id])
  userId       String?

  product      Product @relation(fields: [productId], references: [id])
  productId    String

  quantity     Int @default(1)

  basePriceSnapshot  Decimal @db.Decimal(10,2)
  finalPriceSnapshot Decimal @db.Decimal(10,2)

  customizations CartItemCustomization[]

  createdAt DateTime @default(now())
}

model CartItemCustomization {
  id          String @id @default(uuid())
  cartItem    CartItem @relation(fields: [cartItemId], references: [id])
  cartItemId  String

  type        CustomizationType
  referenceId String
  nameSnapshot String
  priceImpact Decimal @db.Decimal(10,2)
}

//////////////////////////////////////////////////////
// ORDERS
//////////////////////////////////////////////////////

model Order {
  id            String       @id @default(uuid())
  user          User?        @relation(fields: [userId], references: [id])
  userId        String?

  restaurant    Restaurant   @relation(fields: [restaurantId], references: [id])
  restaurantId  String

  fulfillmentType FulfillmentType

  totalAmount   Decimal      @db.Decimal(10,2)
  status        OrderStatus  @default(PENDING)

  stripePaymentIntentId String?
  paidAt        DateTime?

  items         OrderItem[]
  fulfillment   FulfillmentDetails?

  createdAt     DateTime @default(now())
}

//////////////////////////////////////////////////////
// FULFILLMENT DETAILS (OPTIONAL FIELDS)
//////////////////////////////////////////////////////

model FulfillmentDetails {
  id        String @id @default(uuid())

  order     Order  @relation(fields: [orderId], references: [id])
  orderId   String @unique

  // Common optional contact
  contactName  String?
  phoneNumber  String?

  //////////////////////////////////////////////////////
  // DELIVERY FIELDS (optional)
  //////////////////////////////////////////////////////
  street       String?
  building     String?
  state        String?
  locationNote String?

  //////////////////////////////////////////////////////
  // PICKUP FIELDS (optional)
  //////////////////////////////////////////////////////
  pickupTime   DateTime?

  //////////////////////////////////////////////////////
  // DINE-IN FIELDS (optional)
  //////////////////////////////////////////////////////
  reservationTime DateTime?
  tableId         String?
  table           Table? @relation(fields: [tableId], references: [id])

  createdAt DateTime @default(now())
}

//////////////////////////////////////////////////////
// ORDER ITEMS
//////////////////////////////////////////////////////

model OrderItem {
  id           String @id @default(uuid())
  order        Order  @relation(fields: [orderId], references: [id])
  orderId      String

  product      Product? @relation(fields: [productId], references: [id])
  productId    String
  productNameSnapshot String

  quantity     Int

  basePriceSnapshot  Decimal @db.Decimal(10,2)
  finalPriceSnapshot Decimal @db.Decimal(10,2)

  customizations OrderItemCustomization[]
}

model OrderItemCustomization {
  id          String @id @default(uuid())
  orderItem   OrderItem @relation(fields: [orderItemId], references: [id])
  orderItemId String

  type        CustomizationType
  referenceId String
  nameSnapshot String
  priceImpact Decimal @db.Decimal(10,2)
}